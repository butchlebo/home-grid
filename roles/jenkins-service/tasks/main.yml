---

- name: Check if Jenkins service is running
  shell: docker service ls | awk '{print $2}' | grep jenkins
  changed_when: false
  ignore_errors: true
  failed_when: jenkins_status.rc == 2
  register: jenkins_status

- name: Create jenkins volume directory
  hosts: nfs-server[0]
  become: "yes"
  file:
    path: /srv/nfs/jenkins
    mode: 0777
    state: directory
  run_once: true
  when: jenkins_status.rc == 1

- name: Create jenkins local config directory sysmango
  hosts: nfs-server[0]
  become: "yes"
  file:
    path: /srv/nfs/jenkins/sysmango
    mode: 0777
    state: directory
  run_once: true
  when: jenkins_status.rc == 1

- name: Copy docker daemon.json
  hosts: nfs-server[0]
  copy:
    src: daemon.json
    dest: /srv/nfs/jenkins/sysmango

- name: Deploy jenkins service
  hosts: docker-manager[0]
  command: |
    docker service create -d --name jenkins \
    --network mangonet \
    --mount type=bind,src=/srv/docker-volumes/jenkins,dst=/var/jenkins_home \
    --mount=type=bind,src=/var/run/docker.sock,dst=/var/run/docker.sock \
    --constraint=node.role==manager \
    --replicas 1 \
    jenkinsci/blueocean:latest
  run_once: true
  when: jenkins_status.rc == 1

# - uri:
#   url: http://jenkins.sysmango.net 
#   status_code: 200 
#   timeout: 3000
#   async: 3000
#   poll: 10
#   register: amiup
